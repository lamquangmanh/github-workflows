name: Reusable CD for ArgoCD & Kubernetes

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (dev, staging, prod)'
        required: true
        type: string
      docker_repository:
        description: 'Docker repository name'
        required: true
        type: string

jobs:
  cd-process:
    name: Build and push docker image to Docker-hub
    runs-on: ubuntu-latest

    # Prevents parallel execution of the same workflow on the same branch.
    # If a new workflow run starts for the same branch/ref, the previous run is canceled.
    concurrency:
      group: ${{ github.workflow }}-cd-process-${{ github.ref }}
      cancel-in-progress: true

    # Sets the environment dynamically using a GitHub Action input.
    # This value determines which environment (staging, production, etc.) the workflow is targeting.
    environment: ${{ inputs.environment }}

    steps:
      # Clones the repository into the GitHub Actions runner
      - name: Checkout
        uses: actions/checkout@v4

      # This step sets up Node.js on the GitHub Actions runner.
      - name: Setup nodeJs
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://npm.pkg.github.com'

      # Login to docker hub using the credentials stored in GitHub secrets.
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Secrets are injected via ${{ secrets.NODE_ENV }} and passed to the Docker build securely.
      # Executes a custom Docker build script (build.sh).
      # This likely builds a Docker image with the application.
      - name: Build Docker image
        run: |
          BUILD_ARGS="NODE_ENV=${{ inputs.environment }} \
              PORT=${{ secrets.APP_PORT }} \
              GRPC_HOST=${{ secrets.APP_GRPC_HOST }} \
              GRPC_PORT=${{ secrets.APP_GRPC_PORT }} \
              DB_HOST=${{ secrets.APP_DB_HOST }} \
              DB_PORT=${{ secrets.APP_DB_PORT }} \
              DB_USER=${{ secrets.APP_DB_USER }} \
              DB_PASS=${{ secrets.APP_DB_PASS }} \
              DB_NAME=${{ secrets.APP_DB_NAME }} \
              JWT_SECRET=${{ secrets.APP_JWT_SECRET }} \
              JWT_EXPIRATION=${{ secrets.APP_JWT_EXPIRATION }} \
              REDIS_HOST=${{ secrets.APP_REDIS_HOST }} \
              REDIS_PORT=${{ secrets.APP_REDIS_PORT }} \
              REDIS_PASSWORD=${{ secrets.APP_REDIS_PASSWORD }}"
          for ARG in $BUILD_ARGS; do
            ARGS+="--build-arg $ARG "
          done
          docker build $ARGS -t temp .

      - name: Tag and Push to Docker Hub
        run: |
          IMAGE_LATEST="${{ inputs.docker_repository }}:${{ github.sha }}"
          docker tag temp $IMAGE_LATEST
          docker push $IMAGE_LATEST
